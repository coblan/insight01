{% extends "director/index.html" %}
{% load static %}
{% load jsonify %}

{% block page_content %}
<script src='{% static "js/table.pack.js" %}'></script>
<script type="text/javascript">

    bus=new Vue()
    //	row_filters=
    //	placeholder =
    //	row_sort=
    //	heads=
    //	rows=
    //	row_pages =

    //	can_add=
    //	can_del=
    //	search_args=ex.parseSearch()
    //	search字段从 search_args._q 来取值
    $(function () {
        table=new Vue({
            el:'#there',
            data:{
                parents:[],
                par:'',
                dirs:[],
                items:[],
                crt_view:'',
                crt_name:'',
                selected:[],
            },
            mixins:[table_fun],
            watch:{
                'row_sort.sort_str':function (v) {
                    this.search_args._sort=v
                    this.search()
                }
            },
            mounted:function(){
                this.dir_data()
            },
            computed:{
                par_pk:function(){
                    if(this.par){return this.par.pk}
                    else{return null}
                },
                can_rename:function(){
                    
                }
            },
            methods:{
                dir_data:function(par){
                    var self=this
                    this.par=par
                    var post_data=[{fun:'dir_data',par:this.par_pk,}]
                    ex.post(ajax_url,JSON.stringify(post_data),function(resp){
                        self.dirs=resp.dir_data.dirs
                        self.parents=resp.dir_data.parents
                    })
                },
                dir_create:function(){
                    var self=this
                    var post_data=[{fun:'dir_create',par:this.par_pk,name:this.crt_name}]
                    ex.post(ajax_url,JSON.stringify(post_data),function(resp){
                        self.dirs.push(resp.dir_create)
                    })
                },

            },

        })
    })

</script>
<div id='there'>
    <path-nav :menu='menu' v-if="!search_args._pop"></path-nav>
    <div class='btn-panel flex flex-sb' style="padding-left:20px; ">

        <!--<div v-if="row_filters.length==0" class="flex-grow"></div>-->
        <com-filter class="flex" :heads="row_filters" :search="search_args"
                    :search_tip='search_tip' @submit="search()"></com-filter>



    </div>

    <div class="flex">
        <div class="index">
            <ul>
                <li><span @click="dir_data()" class="clickable">root</span></li>
                <li v-for="par in parents"><span v-text="par.name" @click="dir_data(par)" class="clickable"></span></li>
                <li v-if="par"><span v-text="par.name"></span></li>
            </ul>
                <div>
                    <button @click="crt_view='dir_name_editor'">新建目录</button>
                    <button>新建项目</button>
                    <button v-show="can_rename" @click="rename()">重命名</button>
                </div>
                <div>
                    <ul>
                        <li v-for="dir in dirs">
                            <input type="checkbox" v-model="selected"/>
                            <span v-text="dir.name" class="clickable" @click="dir_data(dir)"></span>
                        </li>
                    </ul>
                </div>

            <!--<com-catalog></com-catalog>-->

        </div>
        <div>
            <com-table-btn v-if="!search_args._pop" :add_new="add_new" :del_item="del_item"></com-table-btn>
            <com-table class='table fake-suit' :has_check="!search_args._pop" :map="map"
                       :row_sort="row_sort" :heads="heads" :rows="rows" v-model="selected"></com-table>



            <paginator :nums='row_pages.options' :crt='row_pages.crt_page' @goto_page='goto_page($event)'></paginator>
        </div>
    </div>

<modal v-show="crt_view=='dir_name_editor'" @click.native="crt_view=''">
    <div style="width: 500px;height: 200px;" @click.stop="">
        <label for="">名称</label>
        <input type="text" v-model="crt_name"/>
        <button @click="dir_create()">确定</button>
    </div>

</modal>

</div>
<script type="application/javascript">
    Vue.component('com-catalog',{
        template:'#com-catalog',
        props:{
            /*
            * {
            * dir_data:
            * dir_new:
            * dir_edit:
            * remove
            * move
            * item_new
            * item_edit
            * }
            * */
            url:{},
            dirs:{},
            com_dir:{
                default:function(){
                    return 'com_dir'
                }
            }
        },
        data:function(){
            return {
                par:'',
                dirs:[],
                items:[],
            }
        },
        methods:{

            get_data:function(){
                var self =this
                var url=ex.appendSearch(this.url,{par:this.par})
                ex.get(url,function(resp){
                    self.dirs=resp.dirs
                    self.items=resp.items
                })
            }
        },
        component:{
            com_dir:{
                props:['dir'],
                template:'<li><input type="checkbox"/><span v-text="dir.name"></span></li>'
            }
        }

    })
</script>
<template id="com-catalog">
<div>
    <div>
        <button @click="create_root()">新建目录</button>
        <button>新建项目</button>
    </div>
    <div>
    <ul>
        <component v-for="dir in dirs" :is="com_dir" :dir="dir"></component>
    </ul>
    </div>
</div>
</template>

<style type="text/css" media="screen" id="test">
.index{
    background-color: white;
}
    .clickable:hover{
        cursor: pointer;
    }

</style>
{% block extra %}
{% endblock %}
{% endblock %}